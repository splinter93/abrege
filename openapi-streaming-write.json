{
  "openapi": "3.0.0",
  "info": {
    "title": "Abrégé Streaming API",
    "version": "1.0.0",
    "description": "API pour écrire du contenu en streaming dans une note. Les agents LLM peuvent utiliser cet endpoint pour streamer du contenu généré en temps réel."
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "Serveur de développement local"
    }
  ],
  "paths": {
    "/api/v2/note/{ref}/stream:write": {
      "post": {
        "operationId": "streamWriteToNote",
        "summary": "Écrire du contenu en streaming dans une note",
        "description": "Permet d'envoyer des chunks de contenu en temps réel qui seront affichés immédiatement dans l'éditeur. Utilisé par les agents LLM pour générer du contenu progressivement.\n\n**Flow d'utilisation:**\n1. Envoyer des chunks successifs avec `chunk` (markdown)\n2. Terminer avec `end: true`\n\n**Exemple:**\n```json\n{\"chunk\": \"# Titre\\n\\nPremier paragraphe \"}\n{\"chunk\": \"suite du contenu...\"}\n{\"end\": true}\n```",
        "tags": ["Streaming"],
        "parameters": [
          {
            "name": "ref",
            "in": "path",
            "required": true,
            "description": "ID de la note (UUID) ou slug de la note",
            "schema": {
              "type": "string"
            },
            "example": "7a60e6f5-1cd8-4a7b-b58c-57e066125286"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "chunk": {
                    "type": "string",
                    "description": "Chunk de contenu à ajouter (format markdown). Omis si `end: true`.",
                    "example": "# Introduction\n\nCeci est le premier paragraphe. "
                  },
                  "position": {
                    "type": "string",
                    "enum": ["end", "start", "cursor"],
                    "default": "end",
                    "description": "Position d'insertion du chunk:\n- `end`: À la fin du document (défaut)\n- `start`: Au début du document\n- `cursor`: À la position du curseur actuel"
                  },
                  "end": {
                    "type": "boolean",
                    "description": "Signal de fin de stream. Mettre à `true` pour terminer le stream (pas de `chunk` nécessaire).",
                    "example": false
                  },
                  "metadata": {
                    "type": "object",
                    "description": "Métadonnées optionnelles pour tracking et analytics",
                    "properties": {
                      "tool_call_id": {
                        "type": "string",
                        "description": "ID du tool call pour tracking",
                        "example": "call_abc123"
                      },
                      "agent_id": {
                        "type": "string",
                        "description": "ID de l'agent pour analytics",
                        "example": "synesia-writer-v1"
                      }
                    }
                  }
                },
                "examples": [
                  {
                    "summary": "Envoyer un chunk de contenu",
                    "value": {
                      "chunk": "# Mon Article\n\nCeci est le premier paragraphe avec du **markdown**. ",
                      "position": "end"
                    }
                  },
                  {
                    "summary": "Terminer le stream",
                    "value": {
                      "end": true
                    }
                  },
                  {
                    "summary": "Chunk avec metadata",
                    "value": {
                      "chunk": "Suite du contenu...",
                      "position": "end",
                      "metadata": {
                        "tool_call_id": "call_xyz789",
                        "agent_id": "synesia-writer"
                      }
                    }
                  }
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Chunk envoyé avec succès et broadcasté aux clients",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "note_id": {
                      "type": "string",
                      "format": "uuid",
                      "description": "UUID de la note",
                      "example": "7a60e6f5-1cd8-4a7b-b58c-57e066125286"
                    },
                    "listeners_reached": {
                      "type": "integer",
                      "description": "Nombre de clients qui ont reçu le chunk",
                      "example": 1
                    },
                    "chunk_length": {
                      "type": "integer",
                      "description": "Longueur du chunk envoyé (en caractères)",
                      "example": 45
                    }
                  }
                },
                "example": {
                  "success": true,
                  "note_id": "7a60e6f5-1cd8-4a7b-b58c-57e066125286",
                  "listeners_reached": 1,
                  "chunk_length": 45
                }
              }
            }
          },
          "400": {
            "description": "Erreur de validation (payload invalide)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Validation failed"
                    },
                    "details": {
                      "type": "object",
                      "description": "Détails des erreurs de validation"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Non autorisé (token manquant ou invalide)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Unauthorized"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Note non trouvée ou accès refusé",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Note not found"
                    }
                  }
                }
              }
            }
          },
          "429": {
            "description": "Limite de débit dépassée (max 100 chunks/minute par utilisateur)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Rate limit exceeded"
                    },
                    "retry_after": {
                      "type": "integer",
                      "description": "Nombre de secondes avant de pouvoir réessayer",
                      "example": 30
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Erreur interne du serveur",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Internal server error"
                    }
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "BearerAuth": []
          }
        ]
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Token JWT d'authentification Supabase. Récupérable depuis localStorage après connexion."
      }
    }
  }
}







