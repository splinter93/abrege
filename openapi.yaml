openapi: 3.0.3
info:
  title: Abr√®ge API - LLM-Friendly
  description: API pour la gestion de notes, dossiers et classeurs avec support des slugs et noms LLM-friendly
  version: 1.0.0
  contact:
    name: Support Abr√®ge
    email: support@abrege.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.abrege.com/api/v1
    description: Production
  - url: http://localhost:3000/api/v1
    description: D√©veloppement

security:
  - BearerAuth: []

paths:
  /note/{ref}:
    get:
      summary: R√©cup√©rer une note
      description: R√©cup√®re une note par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
          example: "ma-premiere-note"
      responses:
        '200':
          description: Note r√©cup√©r√©e avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '404':
          description: Note non trouv√©e
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    put:
      summary: Mettre √† jour une note
      description: Met √† jour une note par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NoteUpdate'
      responses:
        '200':
          description: Note mise √† jour avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '404':
          description: Note non trouv√©e
        '422':
          description: Erreur de validation
    
    delete:
      summary: Supprimer une note
      description: Supprime une note par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      responses:
        '200':
          description: Note supprim√©e avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Note supprim√©e"
        '404':
          description: Note non trouv√©e

  /note/create:
    post:
      summary: Cr√©er une note
      description: Cr√©e une nouvelle note avec g√©n√©ration automatique de slug
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NoteCreate'
      responses:
        '201':
          description: Note cr√©√©e avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '422':
          description: Erreur de validation

  /note/overwrite:
    post:
      summary: √âcraser compl√®tement une note
      description: Met √† jour compl√®tement une note (remplace tout le contenu)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NoteOverwrite'
      responses:
        '200':
          description: Note mise √† jour avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '404':
          description: Note non trouv√©e
        '422':
          description: Erreur de validation

  /note/{ref}/add-content:
    patch:
      summary: Ajouter du contenu √† une note
      description: Ajoute du contenu √† la fin d'une note (append-only)
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                text:
                  type: string
                  description: Texte √† ajouter
                  example: "\n## Nouveau contenu ajout√©"
                position:
                  type: integer
                  description: Position d'insertion (optionnel)
                  example: 150
              required:
                - text
      responses:
        '200':
          description: Contenu ajout√© avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '404':
          description: Note non trouv√©e

  /note/{ref}/add-to-section:
    patch:
      summary: Ajouter du contenu √† une section
      description: Ajoute du contenu √† une section sp√©cifique d'une note
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                section:
                  type: string
                  description: Nom ou slug de la section
                  example: "introduction"
                text:
                  type: string
                  description: Texte √† ajouter
                  example: "\nNouveau contenu dans la section"
                position:
                  type: integer
                  description: Position d'insertion (optionnel)
              required:
                - section
                - text
      responses:
        '200':
          description: Contenu ajout√© √† la section avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '404':
          description: Note ou section non trouv√©e

  /note/{ref}/clear-section:
    patch:
      summary: Effacer une section
      description: Efface le contenu d'une section sp√©cifique d'une note
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                section:
                  type: string
                  description: Nom ou slug de la section
                  example: "introduction"
              required:
                - section
      responses:
        '200':
          description: Section effac√©e avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '404':
          description: Note ou section non trouv√©e

  /note/{ref}/table-of-contents:
    get:
      summary: R√©cup√©rer la table des mati√®res
      description: R√©cup√®re la table des mati√®res d'une note
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      responses:
        '200':
          description: Table des mati√®res r√©cup√©r√©e avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  toc:
                    type: array
                    items:
                      $ref: '#/components/schemas/TOCItem'
        '404':
          description: Note non trouv√©e

  /note/{ref}/information:
    get:
      summary: R√©cup√©rer les informations de base
      description: R√©cup√®re les informations de base d'une note
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      responses:
        '200':
          description: Informations r√©cup√©r√©es avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  note:
                    $ref: '#/components/schemas/NoteInfo'
        '404':
          description: Note non trouv√©e
    
    patch:
      summary: Mettre √† jour les informations
      description: Met √† jour les informations de base d'une note
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                source_title:
                  type: string
                  description: Nouveau titre
                header_image:
                  type: string
                  description: Nouvelle image d'en-t√™te
      responses:
        '200':
          description: Informations mises √† jour avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '404':
          description: Note non trouv√©e

  /note/{ref}/statistics:
    get:
      summary: R√©cup√©rer les statistiques
      description: R√©cup√®re les statistiques d√©taill√©es d'une note
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug de la note
          schema:
            type: string
      responses:
        '200':
          description: Statistiques r√©cup√©r√©es avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteStatistics'
        '404':
          description: Note non trouv√©e

  /folder/{ref}:
    get:
      summary: R√©cup√©rer un dossier
      description: R√©cup√®re un dossier par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug du dossier
          schema:
            type: string
      responses:
        '200':
          description: Dossier r√©cup√©r√© avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderResponse'
        '404':
          description: Dossier non trouv√©
    
    put:
      summary: Mettre √† jour un dossier
      description: Met √† jour un dossier par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug du dossier
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Nouveau nom du dossier
                  example: "Nouveau nom"
              required:
                - name
      responses:
        '200':
          description: Dossier mis √† jour avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderResponse'
        '404':
          description: Dossier non trouv√©
    
    delete:
      summary: Supprimer un dossier
      description: Supprime un dossier par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug du dossier
          schema:
            type: string
      responses:
        '200':
          description: Dossier supprim√© avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '404':
          description: Dossier non trouv√©

  /folder/create:
    post:
      summary: Cr√©er un dossier
      description: Cr√©e un nouveau dossier avec g√©n√©ration automatique de slug
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FolderCreate'
      responses:
        '201':
          description: Dossier cr√©√© avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FolderResponse'
        '422':
          description: Erreur de validation

  /notebook/{ref}:
    get:
      summary: R√©cup√©rer un classeur
      description: R√©cup√®re un classeur par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug du classeur
          schema:
            type: string
      responses:
        '200':
          description: Classeur r√©cup√©r√© avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotebookResponse'
        '404':
          description: Classeur non trouv√©
    
    put:
      summary: Mettre √† jour un classeur
      description: Met √† jour un classeur par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug du classeur
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotebookUpdate'
      responses:
        '200':
          description: Classeur mis √† jour avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotebookResponse'
        '404':
          description: Classeur non trouv√©
    
    delete:
      summary: Supprimer un classeur
      description: Supprime un classeur par ID ou slug
      parameters:
        - name: ref
          in: path
          required: true
          description: ID ou slug du classeur
          schema:
            type: string
      responses:
        '200':
          description: Classeur supprim√© avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '404':
          description: Classeur non trouv√©

  /notebook/create:
    post:
      summary: Cr√©er un classeur
      description: Cr√©e un nouveau classeur avec g√©n√©ration automatique de slug
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotebookCreate'
      responses:
        '201':
          description: Classeur cr√©√© avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotebookResponse'
        '422':
          description: Erreur de validation

  /slug/generate:
    post:
      summary: G√©n√©rer un slug
      description: G√©n√®re un slug unique pour un titre donn√©
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  description: Titre pour lequel g√©n√©rer le slug
                  example: "Mon titre avec caract√®res sp√©ciaux: √©√†√ß!"
                type:
                  type: string
                  enum: [note, folder, classeur]
                  description: Type de ressource
                  example: "note"
                userId:
                  type: string
                  description: ID de l'utilisateur
                  example: "3223651c-5580-4471-affb-b3f4456bd729"
              required:
                - title
                - type
                - userId
      responses:
        '200':
          description: Slug g√©n√©r√© avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  slug:
                    type: string
                    example: "mon-titre-avec-caracteres-speciaux-eac"

  /notebooks:
    get:
      summary: Lister les notebooks
      description: R√©cup√®re la liste des notebooks (classeurs) de l'utilisateur
      responses:
        '200':
          description: Liste des notebooks r√©cup√©r√©e avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  notebooks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notebook'
                example:
                  notebooks:
                    - id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
                      slug: "classeur-de-travail"
                      name: "Classeur de Travail"
                      emoji: "üìö"
                      color: "#3b82f6"
                      position: 0
                      created_at: "2024-01-15T10:30:00Z"
                      updated_at: "2024-01-15T10:30:00Z"
        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    NoteResponse:
      type: object
      properties:
        note:
          type: object
          properties:
            id:
              type: string
              format: uuid
            slug:
              type: string
            source_title:
              type: string
            markdown_content:
              type: string
            html_content:
              type: string
            header_image:
              type: string
              nullable: true
            folder_id:
              type: string
              format: uuid
              nullable: true
            classeur_id:
              type: string
              format: uuid
              nullable: true
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            position:
              type: integer

    NoteCreate:
      type: object
      properties:
        source_title:
          type: string
          description: Titre de la note
        markdown_content:
          type: string
          description: Contenu markdown de la note
        header_image:
          type: string
          description: URL de l'image d'en-t√™te
        folder_id:
          type: string
          format: uuid
          description: ID du dossier parent
        classeur_id:
          type: string
          format: uuid
          description: ID du classeur parent
      required:
        - source_title
        - markdown_content

    NoteUpdate:
      type: object
      properties:
        source_title:
          type: string
          description: Nouveau titre
        markdown_content:
          type: string
          description: Nouveau contenu markdown
        header_image:
          type: string
          description: Nouvelle image d'en-t√™te
      required:
        - source_title
        - markdown_content

    NoteOverwrite:
      type: object
      properties:
        note_id:
          type: string
          format: uuid
          description: ID de la note √† √©craser
        source_title:
          type: string
          description: Nouveau titre
        markdown_content:
          type: string
          description: Nouveau contenu markdown
        header_image:
          type: string
          description: Nouvelle image d'en-t√™te
      required:
        - note_id
        - source_title
        - markdown_content

    NoteInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        source_title:
          type: string
        header_image:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        folder_id:
          type: string
          format: uuid
          nullable: true
        classeur_id:
          type: string
          format: uuid
          nullable: true
        slug:
          type: string

    NoteStatistics:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        header_image:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        word_count:
          type: integer
          description: Nombre de mots
        char_count:
          type: integer
          description: Nombre de caract√®res
        section_count:
          type: integer
          description: Nombre de sections
        toc:
          type: array
          items:
            $ref: '#/components/schemas/TOCItem'

    TOCItem:
      type: object
      properties:
        level:
          type: integer
          description: Niveau du titre (1-6)
        title:
          type: string
          description: Titre de la section
        slug:
          type: string
          description: Slug de la section
        line:
          type: integer
          description: Num√©ro de ligne (1-based)
        start:
          type: integer
          description: Position de d√©but dans la ligne

    FolderResponse:
      type: object
      properties:
        folder:
          type: object
          properties:
            id:
              type: string
              format: uuid
            slug:
              type: string
            name:
              type: string
            classeur_id:
              type: string
              format: uuid
            parent_id:
              type: string
              format: uuid
              nullable: true
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            position:
              type: integer

    FolderCreate:
      type: object
      properties:
        name:
          type: string
          description: Nom du dossier
        classeur_id:
          type: string
          format: uuid
          description: ID du classeur parent
        parent_id:
          type: string
          format: uuid
          description: ID du dossier parent (optionnel)
      required:
        - name
        - classeur_id

    NotebookResponse:
      type: object
      properties:
        notebook:
          type: object
          properties:
            id:
              type: string
              format: uuid
            slug:
              type: string
            name:
              type: string
            emoji:
              type: string
              nullable: true
            color:
              type: string
              nullable: true
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            position:
              type: integer

    NotebookCreate:
      type: object
      properties:
        name:
          type: string
          description: Nom du classeur
        emoji:
          type: string
          description: Emoji du classeur
        color:
          type: string
          description: Couleur du classeur
      required:
        - name

    NotebookUpdate:
      type: object
      properties:
        name:
          type: string
          description: Nouveau nom
        emoji:
          type: string
          description: Nouvel emoji
        color:
          type: string
          description: Nouvelle couleur
      required:
        - name

    Error:
      type: object
      properties:
        error:
          type: string
          description: Message d'erreur
        details:
          type: array
          items:
            type: string
          description: D√©tails de l'erreur (optionnel) 