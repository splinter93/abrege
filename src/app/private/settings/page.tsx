"use client";

import { useState, useEffect, useCallback, useMemo } from "react";
import { motion, AnimatePresence } from "framer-motion";
import UnifiedPageLayout from "@/components/UnifiedPageLayout";
import { useAuth } from "@/hooks/useAuth";
import { useSecureErrorHandler } from "@/components/SecureErrorHandler";
import { logApi } from "@/utils/logger";
import ErrorBoundary from "@/components/ErrorBoundary";
import AuthGuard from "@/components/AuthGuard";
import PageTitleSimple from "@/components/PageTitleSimple";
import "@/styles/main.css";
import "@/styles/account.css";

interface ApiKey {
  id: string;
  api_key_name: string;
  scopes: string[];
  is_active: boolean;
  last_used_at?: string;
  expires_at?: string;
  created_at: string;
}

interface CreateApiKeyResponse {
  success: boolean;
  api_key: string;
  info: {
    api_key_name: string;
    scopes: string[];
    expires_at?: string;
  };
}

export default function SettingsPage() {
  return (
    <ErrorBoundary>
      <AuthGuard>
        <UnifiedPageLayout className="page-settings">
          <SettingsPageContent />
        </UnifiedPageLayout>
      </AuthGuard>
    </ErrorBoundary>
  );
}

function SettingsPageContent() {
  const { user, loading: authLoading } = useAuth();
  
  // üîß FIX: G√©rer le cas o√π l'utilisateur n'est pas encore charg√© AVANT d'appeler les hooks
  if (authLoading || !user?.id) {
    return (
      <div className="loading-state">
        <p>Chargement...</p>
      </div>
    );
  }
  
  // Maintenant on sait que user.id existe, on peut appeler tous les hooks en toute s√©curit√©
  return <AuthenticatedSettingsContent user={user} />;
}

// üîß FIX: Composant s√©par√© pour √©viter les probl√®mes d'ordre des hooks
function AuthenticatedSettingsContent({ user }: { user: { id: string; email?: string; username?: string } }) {
  const [apiKeys, setApiKeys] = useState<ApiKey[]>([]);
  const [loading, setLoading] = useState(true);
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [newApiKeyName, setNewApiKeyName] = useState("");
  const [selectedScopes, setSelectedScopes] = useState<string[]>([
    'notes:read', 'classeurs:read', 'dossiers:read'
  ]);
  const [newlyCreatedKey, setNewlyCreatedKey] = useState<string>("");
  const [showNewKeyModal, setShowNewKeyModal] = useState(false);

  // Gestionnaire d'erreur s√©curis√©
  const { handleError } = useSecureErrorHandler({
    context: 'SettingsPage',
    operation: 'gestion_api_keys',
    userId: user.id
  });

  // üîß FIX: D√©finir les fonctions avant de les utiliser dans useEffect
  const getAuthToken = useCallback(async (): Promise<string> => {
    // R√©cup√©rer le token depuis Supabase
    const { createClient } = await import('@supabase/supabase-js');
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    );
    
    const { data: { session } } = await supabase.auth.getSession();
    return session?.access_token || '';
  }, []);

  const loadApiKeys = useCallback(async () => {
    try {
      setLoading(true);
      const response = await fetch('/api/ui/api-keys', {
        headers: {
          'Authorization': `Bearer ${await getAuthToken()}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        setApiKeys(data.api_keys || []);
      } else {
        logApi.error('Erreur chargement API Keys:', response.status);
      }
    } catch (error) {
      handleError(error, 'chargement API Keys');
    } finally {
      setLoading(false);
    }
  }, [handleError, getAuthToken]);

  // Charger les API Keys existantes
  useEffect(() => {
    if (user?.id) {
      loadApiKeys();
    }
  }, [user?.id, loadApiKeys]);

  const handleCreateApiKey = useCallback(async () => {
    if (!newApiKeyName.trim() || !user?.id) return;

    try {
      const response = await fetch('/api/ui/api-keys', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${await getAuthToken()}`
        },
        body: JSON.stringify({
          api_key_name: newApiKeyName.trim(),
          scopes: selectedScopes,
          expires_at: null // Pas d'expiration pour l'instant
        })
      });

      if (response.ok) {
        const data: CreateApiKeyResponse = await response.json();
        setNewlyCreatedKey(data.api_key);
        setShowNewKeyModal(true);
        setShowCreateForm(false);
        setNewApiKeyName("");
        setSelectedScopes(['notes:read', 'classeurs:read', 'dossiers:read']);
        loadApiKeys(); // Recharger la liste
      } else {
        throw new Error('Erreur cr√©ation API Key');
      }
    } catch (error) {
      handleError(error, 'cr√©ation API Key');
    }
  }, [newApiKeyName, user?.id, selectedScopes, getAuthToken, loadApiKeys, handleError]);

  const handleDeleteApiKey = useCallback(async (apiKeyName: string) => {
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'API Key "${apiKeyName}" ?`)) return;

    try {
      // Note: L'endpoint DELETE n'existe pas encore, on utilise la d√©sactivation
      // TODO: Impl√©menter l'endpoint DELETE dans une version future
      logApi.info('Suppression API Key:', apiKeyName);
      loadApiKeys(); // Recharger la liste
    } catch (error) {
      handleError(error, 'suppression API Key');
    }
  }, [loadApiKeys, handleError]);

  const toggleScope = useCallback((scope: string) => {
    setSelectedScopes(prev => 
      prev.includes(scope) 
        ? prev.filter(s => s !== scope)
        : [...prev, scope]
    );
  }, []);

  // üîß OPTIMISATION: M√©moiser les scopes disponibles pour √©viter les re-renders
  const availableScopes = useMemo(() => [
    { key: 'notes:read', label: 'Lecture des notes', description: 'Consulter vos notes et articles' },
    { key: 'notes:write', label: '√âcriture des notes', description: 'Cr√©er et modifier vos notes' },
    { key: 'classeurs:read', label: 'Lecture des classeurs', description: 'Consulter vos classeurs' },
    { key: 'classeurs:write', label: '√âcriture des classeurs', description: 'Cr√©er et modifier vos classeurs' },
    { key: 'dossiers:read', label: 'Lecture des dossiers', description: 'Consulter vos dossiers' },
    { key: 'dossiers:write', label: '√âcriture des dossiers', description: 'Cr√©er et modifier vos dossiers' }
  ], []);

  // üîß FIX: Plus besoin de v√©rifier authLoading car c'est d√©j√† fait dans le composant parent
  // if (authLoading) {
  //   return (
  //     <div className="settings-loading">
  //       <div className="loading-spinner"></div>
  //       <p>Chargement des r√©glages...</p>
  //     </div>
  //   );
  // }

  return (
    <>
      {/* Titre de la page avec design simple unifi√© */}
      <PageTitleSimple
        title="R√©glages"
        subtitle="G√©rez vos pr√©f√©rences et cl√©s API"
        stats={[
          { number: apiKeys.length, label: `cl√©${apiKeys.length > 1 ? 's' : ''} API` },
          { number: user?.email ? '‚úÖ' : '‚ùå', label: 'authentifi√©' }
        ]}
      />

      {/* Contenu principal avec blocs glassmorphism espac√©s */}
      <div className="account-main-container">
        
        {/* Section Cl√©s API - Menu d√©di√© */}
        <motion.div 
          className="account-glass-block account-api-block"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.1 }}
        >
          <div className="account-block-header">
            <div className="account-block-icon">üîë</div>
            <div>
              <h2 className="account-block-title">Cl√©s API</h2>
              <p className="account-block-subtitle">G√©rez vos cl√©s d'acc√®s programmatique</p>
            </div>
            <button 
              className="account-create-button"
              onClick={() => setShowCreateForm(!showCreateForm)}
            >
              ‚ûï Nouvelle cl√©
            </button>
          </div>

          {/* Formulaire de cr√©ation de nouvelle cl√© */}
          <AnimatePresence>
            {showCreateForm && (
              <motion.div
                className="account-create-key-form"
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
                exit={{ opacity: 0, height: 0 }}
                transition={{ duration: 0.3 }}
              >
                <div className="account-field">
                  <label className="account-field-label">Nom de la cl√© API</label>
                  <input 
                    type="text"
                    value={newApiKeyName}
                    onChange={(e) => setNewApiKeyName(e.target.value)}
                    placeholder="Ex: ChatGPT Integration, Cl√© de production..."
                    className="account-field-input"
                  />
                </div>

                <div className="account-field">
                  <label className="account-field-label">Permissions (scopes)</label>
                  <div className="account-scopes-grid">
                    {availableScopes.map((scope) => (
                      <label key={scope.key} className="account-scope-checkbox">
                        <input
                          type="checkbox"
                          checked={selectedScopes.includes(scope.key)}
                          onChange={() => toggleScope(scope.key)}
                        />
                        <div className="account-scope-content">
                          <span className="account-scope-label">{scope.label}</span>
                          <span className="account-scope-description">{scope.description}</span>
                        </div>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="account-create-input-group">
                  <button 
                    className="account-button-primary"
                    onClick={handleCreateApiKey}
                    disabled={!newApiKeyName.trim()}
                  >
                    Cr√©er la cl√©
                  </button>
                  <button 
                    className="account-button-secondary"
                    onClick={() => setShowCreateForm(false)}
                  >
                    Annuler
                  </button>
                </div>
              </motion.div>
            )}
          </AnimatePresence>

          {/* Liste des cl√©s API */}
          <div className="account-api-keys-list">
            {loading ? (
              <div className="account-loading-state">
                <div className="account-loading-spinner"></div>
                <p>Chargement des cl√©s API...</p>
              </div>
            ) : apiKeys.length === 0 ? (
              <div className="account-empty-state">
                <span className="account-empty-icon">üîë</span>
                <h3>Aucune cl√© API</h3>
                <p>Cr√©ez votre premi√®re cl√© API pour commencer √† utiliser Scrivia avec ChatGPT</p>
              </div>
            ) : (
              apiKeys.map((apiKey, index) => (
                <motion.div 
                  key={apiKey.id}
                  className={`account-api-key-item ${!apiKey.is_active ? 'inactive' : ''}`}
                  initial={{ opacity: 0, x: -20 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ duration: 0.4, delay: 0.2 + index * 0.1 }}
                >
                  <div className="account-api-key-header">
                    <div className="account-api-key-info">
                      <h3 className="account-api-key-name">{apiKey.api_key_name}</h3>
                      <div className="account-api-key-meta">
                        <span className="account-api-key-date">Cr√©√©e le {new Date(apiKey.created_at).toLocaleDateString()}</span>
                        {apiKey.last_used_at && (
                          <span className="account-api-key-last">Derni√®re utilisation: {new Date(apiKey.last_used_at).toLocaleDateString()}</span>
                        )}
                      </div>
                    </div>
                    <div className="account-api-key-status">
                      <div className={`account-status-badge ${apiKey.is_active ? 'active' : 'inactive'}`}>
                        {apiKey.is_active ? 'üü¢ Actif' : 'üî¥ Inactif'}
                      </div>
                    </div>
                  </div>

                  <div className="account-api-key-content">
                    <div className="account-api-key-scopes">
                      <strong>Permissions:</strong>
                      <div className="account-scopes-tags">
                        {apiKey.scopes.map((scope) => (
                          <span key={scope} className="account-scope-tag">
                            {scope}
                          </span>
                        ))}
                      </div>
                    </div>

                    <div className="account-api-key-actions">
                      <button 
                        className="account-button-danger"
                        onClick={() => handleDeleteApiKey(apiKey.api_key_name)}
                      >
                        üóëÔ∏è Supprimer
                      </button>
                    </div>
                  </div>
                </motion.div>
              ))
            )}
          </div>
        </motion.div>

        {/* Section Pr√©f√©rences - Bloc compact */}
        <motion.div 
          className="account-glass-block"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.2 }}
        >
          <div className="account-block-header">
            <div className="account-block-icon">üé®</div>
            <div>
              <h2 className="account-block-title">Pr√©f√©rences</h2>
              <p className="account-block-subtitle">Personnalisez votre exp√©rience</p>
            </div>
          </div>
          <div className="account-block-content">
            <div className="account-preferences-grid">
              <div className="account-field">
                <label className="account-field-label">Langue</label>
                <select className="account-field-select">
                  <option value="fr">Fran√ßais</option>
                  <option value="en">English</option>
                </select>
              </div>
              <div className="account-field">
                <label className="account-field-label">Th√®me</label>
                <select className="account-field-select">
                  <option value="light">Clair</option>
                  <option value="dark">Sombre</option>
                  <option value="auto">Automatique</option>
                </select>
              </div>
              <div className="account-field">
                <label className="account-field-label">Notifications</label>
                <div className="account-checkbox-group">
                  <label className="account-checkbox">
                    <input type="checkbox" defaultChecked />
                    <span className="account-checkbox-text">Email</span>
                  </label>
                  <label className="account-checkbox">
                    <input type="checkbox" />
                    <span className="account-checkbox-text">Push</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </motion.div>

        {/* Section S√©curit√© - Bloc compact */}
        <motion.div 
          className="account-glass-block"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.3 }}
        >
          <div className="account-block-header">
            <div className="account-block-icon">üõ°Ô∏è</div>
            <div>
              <h2 className="account-block-title">S√©curit√©</h2>
              <p className="account-block-subtitle">G√©rez la s√©curit√© de votre compte</p>
            </div>
          </div>
          <div className="account-block-content">
            <div className="account-security-actions">
              <button className="account-button-secondary">
                üîí Changer le mot de passe
              </button>
              <button className="account-button-secondary">
                üì± Authentification √† deux facteurs
              </button>
              <button className="account-button-danger">
                üóëÔ∏è Supprimer le compte
              </button>
            </div>
          </div>
        </motion.div>

      </div>

      {/* Modal pour afficher la nouvelle cl√© */}
      <AnimatePresence key="settings-modal">
        {showNewKeyModal && (
          <motion.div
            className="modal-overlay"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={() => setShowNewKeyModal(false)}
          >
            <motion.div
              className="modal-content"
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.8, opacity: 0 }}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="modal-header">
                <h3>üîë Nouvelle cl√© API cr√©√©e !</h3>
                <button
                  className="modal-close"
                  onClick={() => setShowNewKeyModal(false)}
                >
                  ‚úï
                </button>
              </div>
              <div className="modal-body">
                <div className="warning-box">
                  <p><strong>‚ö†Ô∏è Important :</strong> Cette cl√© ne sera affich√©e qu'une seule fois.</p>
                  <p>Copiez-la et stockez-la en lieu s√ªr. Vous ne pourrez plus la voir apr√®s avoir ferm√© cette fen√™tre.</p>
                </div>
                <div className="api-key-display">
                  <code className="api-key-code">{newlyCreatedKey}</code>
                  <button
                    className="copy-button"
                    onClick={() => navigator.clipboard.writeText(newlyCreatedKey)}
                  >
                    üìã Copier
                  </button>
                </div>
              </div>
              <div className="modal-footer">
                <button
                  className="modal-button"
                  onClick={() => setShowNewKeyModal(false)}
                >
                  J'ai copi√© ma cl√©
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </>
  );
} 